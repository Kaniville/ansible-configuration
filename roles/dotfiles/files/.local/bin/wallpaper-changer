#!/bin/python3

# Libraries
from urllib.request import urlopen, urlretrieve
from json import loads
from os import listdir, path
from random import choice
from subprocess import run
from argparse import ArgumentParser

# -------------------------------------------------------------------
# Argument parser setup
argument_parser = ArgumentParser()
argument_parser.add_argument('-p', '--picsum', action='store_true', help='Change the wallpaper to a Picsum picture')
argument_parser.add_argument('-b', '--bing', action='store_true', help='Change the wallpaper to the current Bing wallpaper')
option = argument_parser.parse_args()

# -------------------------------------------------------------------
# Download the current Bing Wallpaper and set it
def bing_wallpaper():
    bing_url = 'https://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=fr-FR'
    bing_json = loads(urlopen(bing_url).read().decode("utf-8"))

    # Select the wallpaper from the Json
    wallpaper_url = "https://bing.com" + bing_json['images'][0]['url']
    wallpaper_file = path.abspath(path.expanduser('~/.cache')) + '/bing_background.jpg'

    # Download an set
    urlretrieve(wallpaper_url, wallpaper_file)
    set_wallpaper(wallpaper_url,wallpaper_file)    

# -------------------------------------------------------------------
# Get random Picsum wallpaper, download it and set it
def picsum_wallpaper():
    wallpaper_url = 'https://picsum.photos/1920/1080'
    wallpaper_file = path.abspath(path.expanduser('~/.cache')) + '/bing_background.jpg'

    # Download an set
    urlretrieve(wallpaper_url, wallpaper_file)
    set_wallpaper(wallpaper_url,wallpaper_file)

 # -------------------------------------------------------------------  
# Set wallpaper
def set_wallpaper(wallpaper_url, wallpaper_file):
    run(['gsettings', 'set', 'org.gnome.desktop.background', 'picture-uri', f'file://{wallpaper_file}'], check=True)
    run(['gsettings', 'set', 'org.gnome.desktop.background', 'picture-uri-dark', f'file://{wallpaper_file}'], check=True)

# -------------------------------------------------------------------
# Select an option
if option.picsum:
    picsum_wallpaper()
if option.bing:
    bing_wallpaper()