---
- name: Create mkinitcpio config
  ansible.builtin.copy:
    src: mkinitcpio.conf
    dest: /etc/mkinitcpio.conf

- name: Check if kernel image exist
  stat:
    path: /boot/initramfs-linux-hardened.img
  register: kernel_image

- name: Run mkinitcpio
  command: mkinitcpio -p linux-hardened
  when: not kernel_image.stat.exists

- name: Configure kernel parameters at boot
  ansible.builtin.copy:
    src: sysctl.d/
    dest: /etc/sysctl.d
